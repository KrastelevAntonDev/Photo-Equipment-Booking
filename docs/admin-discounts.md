# Административные скидки на платежи

## Описание

Реализован функционал для создания платежей со специальными скидками администратором. Это позволяет менеджерам предоставлять индивидуальные скидки по запросу клиентов.

## Сценарий использования

1. Клиент звонит менеджеру и просит скидку
2. Менеджер соглашается предоставить скидку (например, 2000 руб)
3. Менеджер заходит в админку
4. Находит бронирование клиента
5. Создаёт платёж с указанием размера скидки
6. Получает ссылку на оплату
7. Отправляет ссылку клиенту
8. Клиент переходит по ссылке и видит сниженную цену (например, не 24 000, а 22 000)

## API

### Создать платёж со скидкой (администратор)

**Endpoint:** `POST /admin/payments`

**Доступ:** Только администраторы (partial или full)

**Запрос:**
```json
{
  "bookingId": "507f1f77bcf86cd799439011",
  "discountAmount": 2000,
  "discountReason": "Скидка по запросу клиента",
  "return_url": "http://picassostudio.ru/"
}
```

**Параметры:**
- `bookingId` (обязательно) - ID бронирования
- `discountAmount` (обязательно) - Размер скидки в рублях
- `discountReason` (опционально) - Причина предоставления скидки
- `return_url` (опционально) - URL для возврата после оплаты

**Ответ (201):**
```json
{
  "payment": {
    "id": "2d9f24b9-000f-5000-9000-1b5e4e3e5e5e",
    "status": "pending",
    "amount": {
      "value": "22000.00",
      "currency": "RUB"
    },
    "confirmation": {
      "type": "redirect",
      "confirmation_url": "https://yoomoney.ru/checkout/payments/v2/contract?orderId=2d9f24b9-000f-5000-9000-1b5e4e3e5e5e"
    },
    "created_at": "2024-01-15T10:00:00.000Z",
    "metadata": {
      "userId": "507f191e810c19729de860ea",
      "bookingId": "507f1f77bcf86cd799439011",
      "adminDiscount": "2000",
      "adminDiscountReason": "Скидка по запросу клиента",
      "originalAmount": "24000"
    }
  },
  "discount": {
    "amount": 2000,
    "reason": "Скидка по запросу клиента",
    "originalAmount": 24000,
    "finalAmount": 22000
  }
}
```

## Логика работы

### 1. Создание платежа со скидкой

Когда администратор создаёт платёж:
1. Проверяется существование бронирования и пользователя
2. Рассчитывается текущая задолженность (totalPrice - paidAmount)
3. Применяется административная скидка
4. Создаётся платёж в ЮKassa на сниженную сумму
5. В metadata сохраняется:
   - `adminDiscount` - размер скидки
   - `adminDiscountReason` - причина скидки
   - `originalAmount` - исходная сумма до скидки

### 2. Сохранение в базе данных (webhook)

При успешной оплате:
1. Webhook получает платёж от ЮKassa
2. Проверяется наличие `adminDiscount` в metadata
3. Если есть административная скидка:
   - Она суммируется с промокодной скидкой (если была)
   - Сохраняется общая сумма скидок
   - Сохраняется исходная сумма до всех скидок
4. Вся информация сохраняется в таблице payments

## Комбинирование скидок

Система поддерживает комбинирование промокодов и административных скидок:

**Пример:**
- Исходная стоимость бронирования: 24 000 руб
- Промокод "ALAN": -4 000 руб
- Стоимость после промокода: 20 000 руб
- Административная скидка: -2 000 руб
- **Итоговая стоимость: 18 000 руб**

В базе данных будет сохранено:
```javascript
{
  amount: 18000,           // Фактически оплаченная сумма
  originalAmount: 24000,   // Исходная сумма
  discount: 6000,          // Общая скидка (4000 + 2000)
  promocode: "ALAN",       // Использованный промокод
  metadata: {
    adminDiscount: "2000",
    adminDiscountReason: "Скидка по запросу клиента",
    originalAmount: "20000" // Сумма до административной скидки
  }
}
```

## Описание в чеке

При создании платежа со скидкой в описании чека автоматически добавляется информация:
```
Оплата бронирования (скидка 2000 руб: Скидка по запросу клиента)
```

Это позволяет пользователю видеть, почему сумма отличается от стандартной.

## Безопасность

- ✅ Только администраторы с правами `partial` или `full` могут создавать платежи со скидкой
- ✅ Проверяется существование бронирования
- ✅ Проверяется, что бронирование ещё не оплачено полностью
- ✅ Скидка не может быть больше текущей задолженности
- ✅ Вся информация о скидке логируется в metadata

## Примеры использования

### Пример 1: Создание платежа со скидкой 2000 руб

```bash
curl -X POST http://localhost:3000/admin/payments \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "bookingId": "507f1f77bcf86cd799439011",
    "discountAmount": 2000,
    "discountReason": "Скидка постоянному клиенту"
  }'
```

### Пример 2: Полная скидка (бесплатное бронирование)

```bash
curl -X POST http://localhost:3000/admin/payments \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "bookingId": "507f1f77bcf86cd799439011",
    "discountAmount": 24000,
    "discountReason": "Промо-акция для инфлюенсера"
  }'
```

В этом случае клиент получит ссылку на оплату 0 руб (или минимальную сумму, допустимую ЮKassa).

## Отчётность

Вся информация о предоставленных скидках сохраняется:
- В таблице `payments` в полях `discount`, `originalAmount`
- В поле `metadata` с деталями (`adminDiscount`, `adminDiscountReason`)

Это позволяет администраторам:
- Отслеживать все предоставленные скидки
- Анализировать причины скидок
- Формировать отчёты по скидкам
